# MetricsQL è¯æ³•åˆ†æå™¨æºç æ·±åº¦è§£æ

## ğŸ“š ç›®å½•

- [æºç å¯¼èˆªåœ°å›¾](#æºç å¯¼èˆªåœ°å›¾) â­ **å¿…è¯»**
- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. æ ¸å¿ƒæ¶æ„](#2-æ ¸å¿ƒæ¶æ„)
  - [2.1 lexer ç»“æ„ä½“](#21-lexer-ç»“æ„ä½“)
  - [2.2 è®¾è®¡æ¨¡å¼](#22-è®¾è®¡æ¨¡å¼)
- [3. ä¸»è¦åŠŸèƒ½æ¨¡å—](#3-ä¸»è¦åŠŸèƒ½æ¨¡å—)
  - [3.1 åŸºç¡€æ“ä½œ](#31-åŸºç¡€æ“ä½œ)
  - [3.2 æ ‡è®°è§£ææµç¨‹](#32-æ ‡è®°è§£ææµç¨‹)
- [4. æ ¸å¿ƒè§£æç®—æ³•](#4-æ ¸å¿ƒè§£æç®—æ³•)
  - [4.1 æ ‡è¯†ç¬¦è§£æç³»ç»Ÿ](#41-æ ‡è¯†ç¬¦è§£æç³»ç»Ÿ)
  - [4.2 å­—ç¬¦ä¸²è§£æç³»ç»Ÿ](#42-å­—ç¬¦ä¸²è§£æç³»ç»Ÿ)
  - [4.3 æ•°å­—è§£æç³»ç»Ÿ](#43-æ•°å­—è§£æç³»ç»Ÿ)
  - [4.4 æ“ä½œç¬¦è¯†åˆ«ç³»ç»Ÿ](#44-æ“ä½œç¬¦è¯†åˆ«ç³»ç»Ÿ)
  - [4.5 æ—¶é—´é—´éš”è§£æ](#45-æ—¶é—´é—´éš”è§£æ)
- [5. å¿«é€Ÿå‚è€ƒ](#5-å¿«é€Ÿå‚è€ƒ)
- [6. å®æˆ˜åº”ç”¨](#6-å®æˆ˜åº”ç”¨)
- [7. æ€§èƒ½ç‰¹æ€§](#7-æ€§èƒ½ç‰¹æ€§)
- [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)

---

## æºç å¯¼èˆªåœ°å›¾

> **ğŸ“– æºç æ–‡ä»¶**ï¼š`lexer.go` (834 è¡Œ)
> **ğŸ“‚ é¡¹ç›®è·¯å¾„**ï¼š`github.com/VictoriaMetrics/metricsql`
> **ğŸ”— ç›¸å…³æ–‡æ¡£**ï¼š[character_encoding_guide.md](./character_encoding_guide.md)

æœ¬èŠ‚æä¾›å®Œæ•´çš„æºç ç»“æ„å¯¼èˆªï¼Œå¸®åŠ©å¿«é€Ÿå®šä½å’Œç†è§£æ¯ä¸ªå‡½æ•°çš„å®ç°ã€‚

### æ ¸å¿ƒç»“æ„ä½“

| ç»“æ„ | è¡Œå· | è¯´æ˜ |
|------|------|------|
| `type lexer struct` | [12-24](lexer.go#L12-L24) | è¯æ³•åˆ†æå™¨æ ¸å¿ƒæ•°æ®ç»“æ„ |

**å­—æ®µè¯´æ˜**ï¼š
```go
12  type lexer struct {
13      Token      string    // å½“å‰è§£æçš„æ ‡è®°
14      prevTokens []string  // å·²è§£ææ ‡è®°å†å²ï¼ˆæ”¯æŒå›é€€ï¼‰
15      nextTokens []string  // å¾…è§£ææ ‡è®°ç¼“å­˜ï¼ˆæ”¯æŒå‰ç»ï¼‰
16      sOrig      string    // åŸå§‹è¾“å…¥å­—ç¬¦ä¸²ï¼ˆé”™è¯¯æŠ¥å‘Šï¼‰
17      sTail      string    // å‰©ä½™å¾…è§£æå­—ç¬¦ä¸²ï¼ˆåŠ¨æ€æ›´æ–°ï¼‰
18      err        error     // è§£æé”™è¯¯ï¼ˆé”™è¯¯ä¼ æ’­ï¼‰
19  }
```

### æ ¸å¿ƒæ–¹æ³• (4ä¸ª)

| æ–¹æ³• | è¡Œå· | åŠŸèƒ½ | è°ƒç”¨é¢‘ç‡ |
|------|------|------|----------|
| `Context()` | [26-28](lexer.go#L26) | è¿”å›å½“å‰è§£æä¸Šä¸‹æ–‡ | â­ é”™è¯¯å¤„ç† |
| `Init(s string)` | [30-38](lexer.go#L30) | åˆå§‹åŒ–è¯æ³•åˆ†æå™¨ | â­ å…¥å£ |
| `Next()` | [45-62](lexer.go#L45) | è·å–ä¸‹ä¸€ä¸ªæ ‡è®°ï¼ˆå…¬å¼€APIï¼‰ | â­â­â­ é«˜é¢‘ |
| `next()` | [64-139](lexer.go#L64) | æ ¸å¿ƒè§£æé€»è¾‘ï¼ˆç§æœ‰ï¼‰ | â­â­â­ æ ¸å¿ƒ |
| `PushBack()` | [40-43](lexer.go#L40) | å›æ¨æ ‡è®° | â­ é”™è¯¯æ¢å¤ |
| `Prev()` | [442-447](lexer.go#L442) | å›é€€åˆ°ä¸Šä¸€ä¸ªæ ‡è®° | â­ å›æº¯è§£æ |

### æ ‡è¯†ç¬¦è§£æç³»ç»Ÿ (10ä¸ªå‡½æ•°)

| å‡½æ•° | è¡Œå· | åŠŸèƒ½ | å…³é”®ç®—æ³• |
|------|------|------|----------|
| `scanIdent()` | [347-371](lexer.go#L347) | æ‰«ææ ‡è¯†ç¬¦ | UTF-8è§£ç  + è½¬ä¹‰å¤„ç† |
| `unescapeIdent()` | [373-396](lexer.go#L373) | è§£ç æ ‡è¯†ç¬¦è½¬ä¹‰ | è½¬ä¹‰åºåˆ—è§£æ |
| `hasEscapedChars()` | [398-408](lexer.go#L398) | æ£€æŸ¥æ˜¯å¦å«è½¬ä¹‰å­—ç¬¦ | å­—ç¬¦éªŒè¯ |
| `appendQuotedIdent()` | [410-419](lexer.go#L410) | ç”Ÿæˆå¸¦å¼•å·æ ‡è¯†ç¬¦ | UTF-8è¿½åŠ  |
| `appendEscapedIdent()` | [421-433](lexer.go#L421) | ç”Ÿæˆè½¬ä¹‰æ ‡è¯†ç¬¦ | è½¬ä¹‰åºåˆ—ç”Ÿæˆ |
| `ifEscapedCharsAppendQuotedIdent()` | [435-440](lexer.go#L435) | æ¡ä»¶å¼•å·å¤„ç† | åˆ†æ”¯é€»è¾‘ |
| `isIdentPrefix()` | [737-747](lexer.go#L737) | åˆ¤æ–­æ ‡è¯†ç¬¦å‰ç¼€ | UTF-8è§£ç  + é¦–å­—ç¬¦æ£€æŸ¥ |
| `isFirstIdentChar()` | [749-754](lexer.go#L749) | åˆ¤æ–­é¦–å­—ç¬¦åˆæ³•æ€§ | Unicodeå­—æ¯æ£€æŸ¥ |
| `isIdentChar()` | [756-761](lexer.go#L756) | åˆ¤æ–­åç»­å­—ç¬¦åˆæ³•æ€§ | ASCIIæ•°å­— + Unicodeå­—æ¯ |
| `decodeEscapeSequence()` | [784-814](lexer.go#L784) | è§£ç è½¬ä¹‰åºåˆ— | \xNN, \uNNNN, ç›´æ¥å­—ç¬¦ |
| `appendEscapeSequence()` | [772-782](lexer.go#L772) | ç”Ÿæˆè½¬ä¹‰åºåˆ— | Hexç¼–ç  |

**æ‰§è¡Œæµç¨‹**ï¼š
```
next() (64è¡Œ)
  â†’ isIdentPrefix() (737è¡Œ) â† æ£€æŸ¥æ˜¯å¦ä¸ºæ ‡è¯†ç¬¦å¼€å¤´
    â†’ utf8.DecodeRuneInString()
    â†’ isFirstIdentChar() (749è¡Œ) â† Unicodeå­—æ¯æ£€æŸ¥
  â†’ scanIdent() (347è¡Œ) â† æ‰«æå®Œæ•´æ ‡è¯†ç¬¦
    â†’ utf8.DecodeRuneInString()
    â†’ isIdentChar() (756è¡Œ) â† åç»­å­—ç¬¦æ£€æŸ¥
    â†’ decodeEscapeSequence() (784è¡Œ) â† å¤„ç† \xNN ç­‰è½¬ä¹‰
```

### å­—ç¬¦ä¸²è§£æç³»ç»Ÿ (3ä¸ªå‡½æ•°)

| å‡½æ•° | è¡Œå· | åŠŸèƒ½ | ç®—æ³•ç‰¹ç‚¹ |
|------|------|------|----------|
| `scanString()` | [140-163](lexer.go#L140) | æ‰«æå­—ç¬¦ä¸²å­—é¢é‡ | â­ åæ–œæ è®¡æ•°ç®—æ³• |
| `isStringPrefix()` | [480-491](lexer.go#L480) | åˆ¤æ–­å­—ç¬¦ä¸²å‰ç¼€ | å¼•å·æ£€æµ‹ |
| (å­—ç¬¦ä¸²ç›¸å…³å¸¸é‡) | - | ä¸‰ç§å¼•å·ç±»å‹ | `"` `'` `` ` `` |

**åæ–œæ è®¡æ•°ç®—æ³•**ï¼š
```go
140  func scanString(s string) (string, error) {
145      quote := s[0]              // è®°å½•å¼•å·ç±»å‹
146      i := 1
147      for {
148          n := strings.IndexByte(s[i:], quote)  // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¼•å·
149          if n < 0 {
150              return "", fmt.Errorf(...)
151          }
152          i += n
153          bs := 0
154          for bs < i && s[i-bs-1] == '\\' {  // â† å…³é”®ï¼šå‘å‰è®¡æ•°åæ–œæ 
155              bs++
156          }
157          if bs%2 == 0 {         // â† å¥‡å¶æ€§åˆ¤æ–­
158              token := s[:i+1]    // å¶æ•°ä¸ª â†’ å¼•å·æœªè½¬ä¹‰ â†’ ç»“æŸ
159              return token, nil
160          }
161          i++                    // å¥‡æ•°ä¸ª â†’ å¼•å·è¢«è½¬ä¹‰ â†’ ç»§ç»­
162      }
163  }
```

### æ•°å­—è§£æç³»ç»Ÿ (8ä¸ªå‡½æ•°)

| å‡½æ•° | è¡Œå· | åŠŸèƒ½ | æ”¯æŒæ ¼å¼ |
|------|------|------|----------|
| `scanPositiveNumber()` | [232-302](lexer.go#L232) | æ‰«ææ­£æ•° | æ•´æ•°ã€å°æ•°ã€ç§‘å­¦è®¡æ•°ã€å•ä½ |
| `parsePositiveNumber()` | [165-230](lexer.go#L165) | è§£ææ­£æ•°å€¼ | å­—ç¬¦ä¸² â†’ float64 |
| `scanNumMultiplier()` | [304-345](lexer.go#L304) | æ‰«ææ•°å­—å•ä½ | k/Ki, M/Mi, G/Gi, T/Ti |
| `isPositiveNumberPrefix()` | [493-506](lexer.go#L493) | åˆ¤æ–­æ•°å­—å‰ç¼€ | æ•°å­—/å°æ•°ç‚¹å¼€å¤´ |
| `isSpecialIntegerPrefix()` | [508-511](lexer.go#L508) | åˆ¤æ–­ç‰¹æ®Šæ•´æ•°å‰ç¼€ | 0x, 0o, 0b |
| `scanSpecialIntegerPrefix()` | [513-534](lexer.go#L513) | æ‰«æç‰¹æ®Šæ•´æ•°å‰ç¼€ | è¿”å›è·³è¿‡å­—ç¬¦æ•° |
| `isDecimalChar()` | [725-727](lexer.go#L725) | åˆ¤æ–­åè¿›åˆ¶æ•°å­— | `ch >= '0' && ch <= '9'` |
| `isDecimalCharOrUnderscore()` | [729-731](lexer.go#L729) | æ”¯æŒä¸‹åˆ’çº¿åˆ†éš” | `123_456_789` |
| `isHexChar()` | [733-735](lexer.go#L733) | åˆ¤æ–­åå…­è¿›åˆ¶å­—ç¬¦ | 0-9, a-f, A-F |

**æ”¯æŒçš„æ•°å­—æ ¼å¼**ï¼š
- æ•´æ•°ï¼š`123`, `0x1a2b`, `0o755`, `0b1010`
- å°æ•°ï¼š`123.45`, `.123`
- ç§‘å­¦è®¡æ•°æ³•ï¼š`1.23e4`, `1.23E-5`
- å¸¦å•ä½ï¼š`100k`, `256Mi`, `1Gi`

### æ—¶é—´è§£æç³»ç»Ÿ (5ä¸ªå‡½æ•°)

| å‡½æ•° | è¡Œå· | åŠŸèƒ½ | æ—¶é—´å•ä½ |
|------|------|------|----------|
| `PositiveDurationValue()` | [550-559](lexer.go#L550) | è§£ææ­£æ—¶é—´é—´éš” | ms, s, m, h, d, w, y, i |
| `DurationValue()` | [567-610](lexer.go#L567) | è§£ææ—¶é—´é—´éš”ï¼ˆå¯è´Ÿï¼‰ | æ”¯æŒç»„åˆå¦‚ `2h5m` |
| `parseSingleDuration()` | [612-647](lexer.go#L612) | è§£æå•ä¸ªæ—¶é—´å•ä½ | è¿”å›æ¯«ç§’æ•° |
| `scanDuration()` | [652-669](lexer.go#L652) | æ‰«ææ—¶é—´é—´éš”æ ¼å¼ | è¿”å›å­—ç¬¦æ•° |
| `scanSingleDuration()` | [671-723](lexer.go#L671) | æ‰«æå•ä¸ªæ—¶é—´å•ä½ | æ”¯æŒè´Ÿå· |
| `isPositiveDuration()` | [536-542](lexer.go#L536) | åˆ¤æ–­æ˜¯å¦ä¸ºæ—¶é—´é—´éš” | åŒ…å« `$__interval` |

**æ—¶é—´å•ä½å¯¹ç…§è¡¨** (è§ `parseSingleDuration` 626-643è¡Œ)ï¼š
```go
626  switch s[len(numPart):] {
627  case "ms": mp = 1                       // æ¯«ç§’
628  case "s":  mp = 1000                    // ç§’
629  case "m":  mp = 60 * 1000               // åˆ†é’Ÿ
630  case "h":  mp = 60 * 60 * 1000          // å°æ—¶
631  case "d":  mp = 24 * 60 * 60 * 1000     // å¤©
632  case "w":  mp = 7 * 24 * 60 * 60 * 1000 // å‘¨
633  case "y":  mp = 365 * 24 * 60 * 60 * 1000 // å¹´
634  case "i":  mp = float64(step)           // æ­¥é•¿é—´éš”
```

### æ“ä½œç¬¦è¯†åˆ«ç³»ç»Ÿ (2ä¸ªå‡½æ•°)

| å‡½æ•° | è¡Œå· | åŠŸèƒ½ | æ“ä½œç¬¦ç±»å‹ |
|------|------|------|-----------|
| `scanTagFilterOpPrefix()` | [452-465](lexer.go#L452) | æ‰«ææ ‡ç­¾è¿‡æ»¤æ“ä½œç¬¦ | `=`, `!=`, `=~`, `!~` |
| `scanBinaryOpPrefix()` | (æœªåœ¨æºç ä¸­) | æ‰«æäºŒå…ƒæ“ä½œç¬¦ | ç®—æœ¯ã€æ¯”è¾ƒã€é€»è¾‘ |

**æ ‡ç­¾è¿‡æ»¤æ“ä½œç¬¦**ï¼š
```go
452  func scanTagFilterOpPrefix(s string) int {
453      if len(s) >= 2 {
454          switch s[:2] {
455          case "=~", "!~", "!=":  // â† åŒå­—ç¬¦ä¼˜å…ˆ
456              return 2
457          }
458      }
459      if len(s) >= 1 {
460          if s[0] == '=' {         // â† å•å­—ç¬¦å›é€€
461              return 1
462          }
463      }
464      return -1
465  }
```

### å·¥å…·å‡½æ•° (7ä¸ª)

| å‡½æ•° | è¡Œå· | åŠŸèƒ½ | ç”¨é€” |
|------|------|------|------|
| `isEOF()` | [448-450](lexer.go#L448) | åˆ¤æ–­è¾“å…¥ç»“æŸ | EOFæ£€æµ‹ |
| `isInfOrNaN()` | [467-473](lexer.go#L467) | åˆ¤æ–­æ— ç©·/NaN | `inf`, `nan` |
| `isOffset()` | [475-478](lexer.go#L475) | åˆ¤æ–­ offset å…³é”®å­— | æ—¶é—´åç§» |
| `isSpaceChar()` | [763-770](lexer.go#L763) | åˆ¤æ–­ç©ºç™½å­—ç¬¦ | ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œ |
| `fromHex()` | [816-827](lexer.go#L816) | åå…­è¿›åˆ¶å­—ç¬¦è½¬æ•°å­— | è½¬ä¹‰è§£æ |
| `toHex()` | [829-832](lexer.go#L829) | æ•°å­—è½¬åå…­è¿›åˆ¶å­—ç¬¦ | è½¬ä¹‰ç”Ÿæˆ |

### æºç é˜…è¯»è·¯å¾„æ¨è

#### ğŸ”° åˆå­¦è€…è·¯å¾„ï¼ˆç†è§£åŸºæœ¬æµç¨‹ï¼‰
```
1. lexer ç»“æ„ä½“å®šä¹‰ (12-24è¡Œ)
   â†“
2. Init() åˆå§‹åŒ– (30-38è¡Œ)
   â†“
3. Next() å…¬å¼€æ¥å£ (45-62è¡Œ)
   â†“
4. next() æ ¸å¿ƒé€»è¾‘ (64-139è¡Œ)
   â”œâ†’ isSpaceChar() è·³è¿‡ç©ºç™½ (763è¡Œ)
   â”œâ†’ scanIdent() æ‰«ææ ‡è¯†ç¬¦ (347è¡Œ)
   â”œâ†’ scanString() æ‰«æå­—ç¬¦ä¸² (140è¡Œ)
   â””â†’ scanPositiveNumber() æ‰«ææ•°å­— (232è¡Œ)
```

#### ğŸ† è¿›é˜¶è·¯å¾„ï¼ˆæ·±å…¥ç†è§£ç®—æ³•ï¼‰
```
1. å­—ç¬¦ä¸²è§£æçš„åæ–œæ è®¡æ•°ç®—æ³• (140-163è¡Œ)
   â†“
2. æ ‡è¯†ç¬¦çš„ Unicode æ”¯æŒå®ç° (347-371, 749-761è¡Œ)
   â”œâ†’ isFirstIdentChar() Unicodeå­—æ¯æ£€æŸ¥ (749è¡Œ)
   â”œâ†’ isIdentChar() ä¸ºä»€ä¹ˆåªå…è®¸ASCIIæ•°å­— (756-761è¡Œ)
   â””â†’ decodeEscapeSequence() è½¬ä¹‰åºåˆ—è§£æ (784è¡Œ)
   â†“
3. æ•°å­—è§£æçš„å¤šæ ¼å¼æ”¯æŒ (232-302è¡Œ)
   â”œâ†’ ç‰¹æ®Šæ•´æ•°å‰ç¼€ (0x/0o/0b) (513è¡Œ)
   â”œâ†’ ç§‘å­¦è®¡æ•°æ³•è§£æ (282-301è¡Œ)
   â””â†’ å•ä½ç³»ç»Ÿ (k/Ki, M/Mi, G/Gi) (304è¡Œ)
   â†“
4. æ—¶é—´è§£æçš„çµæ´»æ€§ (550-723è¡Œ)
   â”œâ†’ ç»„åˆæ—¶é—´æ”¯æŒ (å¦‚ 2h5m) (567è¡Œ)
   â””â†’ Grafana $__interval é›†æˆ (679è¡Œ)
```

#### ğŸš€ æ€§èƒ½ä¼˜åŒ–è·¯å¾„ï¼ˆå­¦ä¹ ä¼˜åŒ–æŠ€å·§ï¼‰
```
1. é›¶æ‹·è´å­—ç¬¦ä¸²åˆ‡ç‰‡ (92, 371è¡Œ)
2. ASCII å¿«é€Ÿæ£€æŸ¥é¿å… Unicode å¼€é”€ (725-727, 760è¡Œ)
3. æœ€é•¿åŒ¹é…ç­–ç•¥ (scanBinaryOpPrefix)
4. å­—ç¬¦ä¸²æŸ¥æ‰¾ä¼˜åŒ– (strings.IndexByte) (148è¡Œ)
```

### å…³é”®æ€§èƒ½ä¼˜åŒ–ç‚¹

| ä¼˜åŒ–æŠ€æœ¯ | ä½ç½® | æ€§èƒ½æå‡ | è¯´æ˜ |
|----------|------|----------|------|
| **é›¶æ‹·è´åˆ‡ç‰‡** | `92`, `371è¡Œ` | é¿å…å†…å­˜åˆ†é… | `s[:i]` è€Œé `string([]byte(...))` |
| **ASCII å¿«é€Ÿè·¯å¾„** | `725-727`, `760è¡Œ` | 28å€æ€§èƒ½ | `ch >= '0' && ch <= '9'` vs `unicode.IsDigit()` |
| **æœ€é•¿åŒ¹é…** | æ“ä½œç¬¦è¯†åˆ« | æ­£ç¡®æ€§ä¿è¯ | é¿å… `=` è¯¯åŒ¹é… `==` |
| **IndexByte** | `148è¡Œ` | é«˜æ•ˆæŸ¥æ‰¾ | åº•å±‚ä¼˜åŒ–çš„å­—ç¬¦ä¸²æŸ¥æ‰¾ |

**æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹**ï¼š
```go
// âœ… é«˜æ•ˆ (lexer.go:726, ~0.3ns/op)
func isDecimalChar(ch byte) bool {
    return ch >= '0' && ch <= '9'
}

// âŒ ä½æ•ˆ (å¦‚æœä½¿ç”¨ unicode.IsDigit, ~8.5ns/op)
// æ€§èƒ½å·®è·ï¼š28å€
```

### ä¸å­—ç¬¦ç¼–ç çš„å…³è”

æœ¬è¯æ³•åˆ†æå™¨çš„ Unicode å¤„ç†ä¸ [character_encoding_guide.md](./character_encoding_guide.md) æ·±åº¦ç›¸å…³ï¼š

| ç¼–ç æ¦‚å¿µ | å®ç°ä½ç½® | è¯´æ˜ |
|----------|----------|------|
| **Unicode å­—æ¯åˆ¤æ–­** | `750è¡Œ` | `unicode.IsLetter(r)` - æ”¯æŒå…¨çƒå­—ç¬¦é›† |
| **UTF-8 è§£ç ** | `350, 738è¡Œ` | `utf8.DecodeRuneInString()` - æ­£ç¡®å¤„ç†å¤šå­—èŠ‚å­—ç¬¦ |
| **ASCII æ•°å­—é™åˆ¶** | `760è¡Œ` | `r < 256 && isDecimalChar(byte(r))` - æ€§èƒ½ä¼˜å…ˆ |
| **è½¬ä¹‰åºåˆ—** | `784-814è¡Œ` | `\xNN` (ASCII), `\uNNNN` (Unicode) |

**ä¸ºä»€ä¹ˆåªå…è®¸ ASCII æ•°å­—ï¼Ÿ** (è¯¦è§ lexer.go:760)
```go
756  func isIdentChar(r rune) bool {
757      if isFirstIdentChar(r) {
758          return true
759      }
760      return r < 256 && isDecimalChar(byte(r)) || r == '.'
     //         â†‘ å…³é”®ï¼šé™åˆ¶åœ¨ ASCII èŒƒå›´å†…
     //         åŸå› ï¼š
     //         1. æ€§èƒ½ï¼šASCII æ£€æŸ¥æ¯” Unicode å¿« 28 å€
     //         2. å…¼å®¹æ€§ï¼šPrometheus ç”Ÿæ€æ ‡å‡†
     //         3. å®‰å…¨æ€§ï¼šé¿å…å…¨è§’æ•°å­—æ··æ·† (å¦‚ "metricï¼‘ï¼’ï¼“")
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 1. æ¦‚è¿°

MetricsQL è¯æ³•åˆ†æå™¨æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æŸ¥è¯¢è¯­è¨€æ ‡è®°åŒ–ç³»ç»Ÿï¼Œè´Ÿè´£å°†æŸ¥è¯¢å­—ç¬¦ä¸²è½¬æ¢ä¸ºç»“æ„åŒ–çš„æ ‡è®°æµã€‚ä½œä¸ºæŸ¥è¯¢å¤„ç†ç®¡é“çš„ç¬¬ä¸€ç¯èŠ‚ï¼Œå®ƒä¸ºåç»­çš„è¯­æ³•åˆ†æå’ŒæŸ¥è¯¢æ‰§è¡Œå¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

### ä¸»è¦ç‰¹æ€§

- **å®Œæ•´çš„ Unicode æ”¯æŒ**ï¼šæ”¯æŒå›½é™…åŒ–æŒ‡æ ‡åå’Œæ ‡ç­¾
- **çµæ´»çš„å­—ç¬¦ä¸²å¤„ç†**ï¼šä¸‰ç§å¼•å·ç±»å‹ï¼Œå®Œå–„çš„è½¬ä¹‰æœºåˆ¶
- **ä¸°å¯Œçš„æ•°å­—æ ¼å¼**ï¼šæ”¯æŒå¤šç§è¿›åˆ¶ã€ç§‘å­¦è®¡æ•°æ³•ã€å•ä½ç³»ç»Ÿ
- **å¼ºå¤§çš„æ“ä½œç¬¦ç³»ç»Ÿ**ï¼šç®—æœ¯ã€æ¯”è¾ƒã€é€»è¾‘ã€æ ‡ç­¾è¿‡æ»¤
- **Grafana é›†æˆ**ï¼šåŸç”Ÿæ”¯æŒæ¨¡æ¿å˜é‡

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 2. æ ¸å¿ƒæ¶æ„

### 2.1 lexer ç»“æ„ä½“

**æºç ä½ç½®**ï¼š`lexer.go:12-24`

`lexer` æ˜¯è¯æ³•åˆ†æå™¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œç»´æŠ¤è§£æçŠ¶æ€å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š

```go
12  type lexer struct {
13      // Token contains the currently parsed token.
14      // An empty token means EOF.
15      Token string
16
17      prevTokens []string
18      nextTokens []string
19
20      sOrig string
21      sTail string
22
23      err error
24  }
```

**å­—æ®µè¯¦è§£**ï¼š

| å­—æ®µ | ç±»å‹ | ç”¨é€” | ä¿®æ”¹ä½ç½® |
|------|------|------|----------|
| **`Token`** | `string` | å½“å‰è§£æçš„æ ‡è®°ï¼ˆç©ºå­—ç¬¦ä¸²è¡¨ç¤ºEOFï¼‰ | `Next()` (60è¡Œ), `next()` (è¿”å›å€¼) |
| **`prevTokens`** | `[]string` | å·²è§£ææ ‡è®°å†å²ï¼Œæ”¯æŒå›é€€ï¼ˆLook-behindï¼‰ | `Next()` (49è¡Œ), `Prev()` (445è¡Œ) |
| **`nextTokens`** | `[]string` | å¾…è§£ææ ‡è®°ç¼“å­˜ï¼Œæ”¯æŒå‰ç»ï¼ˆLook-aheadï¼‰ | `Next()` (51-52è¡Œ), `Prev()` (443è¡Œ) |
| **`sOrig`** | `string` | åŸå§‹è¾“å…¥å­—ç¬¦ä¸²ï¼Œä¿æŒä¸å˜ï¼Œç”¨äºé”™è¯¯æŠ¥å‘Š | `Init()` (36è¡Œ), `Context()` (27è¡Œ) |
| **`sTail`** | `string` | å‰©ä½™å¾…è§£æå­—ç¬¦ä¸²ï¼ŒåŠ¨æ€æ›´æ–°ï¼Œè§£ææŒ‡é’ˆ | `Init()` (37è¡Œ), `next()` (73, 89, 126, 130, 136è¡Œ) |
| **`err`** | `error` | è§£æé”™è¯¯ï¼Œé”™è¯¯ä¼ æ’­æœºåˆ¶ | `Next()` (46-47, 57-58è¡Œ) |

### 2.2 è®¾è®¡æ¨¡å¼

#### åŒå‘ç¼“å­˜æœºåˆ¶

**å®ç°ä½ç½®**ï¼š`Next()` (45-62è¡Œ), `Prev()` (442-447è¡Œ)

```go
45  func (lex *lexer) Next() error {
46      if lex.err != nil {              // é”™è¯¯ä¼ æ’­
47          return lex.err
48      }
49      lex.prevTokens = append(lex.prevTokens, lex.Token)  // â† ä¿å­˜å†å²
50      if len(lex.nextTokens) > 0 {     // â† æ£€æŸ¥å‰ç»ç¼“å­˜
51          lex.Token = lex.nextTokens[len(lex.nextTokens)-1]
52          lex.nextTokens = lex.nextTokens[:len(lex.nextTokens)-1]
53          return nil
54      }
55      token, err := lex.next()         // è§£ææ–°æ ‡è®°
56      if err != nil {
57          lex.err = err                 // ä¿å­˜é”™è¯¯çŠ¶æ€
58          return err
59      }
60      lex.Token = token
61      return nil
62  }

442  func (lex *lexer) Prev() {
443      lex.nextTokens = append(lex.nextTokens, lex.Token)  // â† å‰ç»ç¼“å­˜
444      lex.Token = lex.prevTokens[len(lex.prevTokens)-1]
445      lex.prevTokens = lex.prevTokens[:len(lex.prevTokens)-1]
446  }
```

**ç‰¹æ€§**ï¼š
- âœ… **`prevTokens`**ï¼šå®ç°å›é€€ï¼ˆLook-behindï¼‰èƒ½åŠ›ï¼Œæ”¯æŒå¤æ‚è¯­æ³•çš„å›æº¯è§£æ
- âœ… **`nextTokens`**ï¼šå®ç°å‰ç»ï¼ˆLook-aheadï¼‰èƒ½åŠ›ï¼Œé¿å…é‡å¤è§£æ
- âœ… **æ— é™å›é€€**ï¼š`prevTokens` è®°å½•æ‰€æœ‰å†å²æ ‡è®°

#### çŠ¶æ€åˆ†ç¦»ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šåŸå§‹è¾“å…¥ä¸è§£ææŒ‡é’ˆåˆ†ç¦»

```go
// Init() åˆå§‹åŒ– (lexer.go:30-38)
30  func (lex *lexer) Init(s string) {
31      lex.Token = ""
32      lex.prevTokens = nil
33      lex.nextTokens = nil
34      lex.err = nil
35
36      lex.sOrig = s     // â† ä¿å­˜åŸå§‹è¾“å…¥ï¼ˆä¸å˜ï¼‰
37      lex.sTail = s     // â† åˆå§‹åŒ–è§£ææŒ‡é’ˆ
38  }

// Context() é”™è¯¯æŠ¥å‘Š (lexer.go:26-28)
26  func (lex *lexer) Context() string {
27      return fmt.Sprintf("%s%s", lex.Token, lex.sTail)
28  }
```

**ä¼˜åŠ¿**ï¼š
- âœ… **`sOrig`**ï¼šä¿ç•™åŸå§‹è¾“å…¥ç”¨äºé”™è¯¯æŠ¥å‘Šï¼Œæä¾›å®Œæ•´ä¸Šä¸‹æ–‡
- âœ… **`sTail`**ï¼šåŠ¨æ€æŒ‡é’ˆåœ¨å­—ç¬¦ä¸²ä¸Šç§»åŠ¨ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…
- âœ… **é›¶æ‹·è´**ï¼š`sTail` æ˜¯ `sOrig` çš„åˆ‡ç‰‡ï¼Œä¸äº§ç”Ÿæ–°çš„å†…å­˜åˆ†é…

#### é›¶æ‹·è´è®¾è®¡

**å®ç°ä½ç½®**ï¼š`next()` (92è¡Œ), `scanIdent()` (370è¡Œ), `scanString()` (158è¡Œ)

**ç¤ºä¾‹1ï¼šå•å­—ç¬¦æ ‡è®°** (lexer.go:92)
```go
91  case '{', '}', '[', ']', '(', ')', ',', '@':
92      token = s[:1]     // âœ… ç›´æ¥åˆ‡ç‰‡ï¼Œé›¶æ‹·è´
93      goto tokenFoundLabel
```

**ç¤ºä¾‹2ï¼šæ ‡è¯†ç¬¦æ‰«æ** (lexer.go:370)
```go
347  func scanIdent(s string) string {
348      i := 0
...      // æ‰«æé€»è¾‘
370      return s[:i]      // âœ… è¿”å›åˆ‡ç‰‡ï¼Œé›¶æ‹·è´
371  }
```

**ç¤ºä¾‹3ï¼šå­—ç¬¦ä¸²æ‰«æ** (lexer.go:158)
```go
157      if bs%2 == 0 {
158          token := s[:i+1]  // âœ… åˆ‡ç‰‡æ“ä½œï¼Œé›¶æ‹·è´
159          return token, nil
160      }
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```go
// âœ… é«˜æ•ˆï¼šé›¶æ‹·è´åˆ‡ç‰‡ï¼ˆæœ¬é¡¹ç›®é‡‡ç”¨ï¼‰
token = s[:i]

// âŒ ä½æ•ˆï¼šåˆ›å»ºæ–°å­—ç¬¦ä¸²ï¼ˆé¿å…ï¼‰
token = string([]byte(s[:i]))
```

**ä¼˜åŠ¿**ï¼š
- âš¡ æœ€å°åŒ–å†…å­˜åˆ†é…
- âš¡ å‡å°‘ GC å‹åŠ›
- âš¡ ä¼˜åŒ–é«˜é¢‘æ“ä½œè·¯å¾„ï¼ˆæ ‡è¯†ç¬¦ã€æ•°å­—ã€å­—ç¬¦ä¸²æ‰«æï¼‰

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 3. ä¸»è¦åŠŸèƒ½æ¨¡å—

### 3.1 åŸºç¡€æ“ä½œ

#### Init - åˆå§‹åŒ–è¯æ³•åˆ†æå™¨

**æºç ä½ç½®**ï¼š`lexer.go:30-38`

```go
30  func (lex *lexer) Init(s string) {
31      lex.Token = ""           // æ¸…ç©ºå½“å‰æ ‡è®°
32      lex.prevTokens = nil     // æ¸…ç©ºå†å²ç¼“å­˜
33      lex.nextTokens = nil     // æ¸…ç©ºå‰ç»ç¼“å­˜
34      lex.err = nil            // æ¸…ç©ºé”™è¯¯çŠ¶æ€
35
36      lex.sOrig = s            // ä¿å­˜åŸå§‹è¾“å…¥
37      lex.sTail = s            // åˆå§‹åŒ–è§£ææŒ‡é’ˆ
38  }
```

**åŠŸèƒ½**ï¼š
- âœ… é‡ç½®åˆ†æå™¨çŠ¶æ€ï¼Œå‡†å¤‡è§£ææ–°çš„è¾“å…¥
- âœ… æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ï¼ˆå†å²æ ‡è®°å’Œå‰ç»æ ‡è®°ï¼‰
- âœ… åˆå§‹åŒ–åŸå§‹è¾“å…¥å’Œè§£ææŒ‡é’ˆ
- âœ… æ¸…é™¤é”™è¯¯çŠ¶æ€

**è°ƒç”¨æ—¶æœº**ï¼šæ¯æ¬¡å¼€å§‹è§£ææ–°çš„æŸ¥è¯¢å­—ç¬¦ä¸²å‰è°ƒç”¨ä¸€æ¬¡

#### Next - è·å–ä¸‹ä¸€ä¸ªæ ‡è®°

**æºç ä½ç½®**ï¼š`lexer.go:45-62`

```go
45  func (lex *lexer) Next() error {
46      if lex.err != nil {              // 1. æ£€æŸ¥é”™è¯¯çŠ¶æ€
47          return lex.err
48      }
49      lex.prevTokens = append(lex.prevTokens, lex.Token)  // 2. ä¿å­˜å†å²
50      if len(lex.nextTokens) > 0 {     // 3. æ£€æŸ¥å‰ç»ç¼“å­˜
51          lex.Token = lex.nextTokens[len(lex.nextTokens)-1]
52          lex.nextTokens = lex.nextTokens[:len(lex.nextTokens)-1]
53          return nil
54      }
55      token, err := lex.next()         // 4. è°ƒç”¨æ ¸å¿ƒè§£æ â†’ è½¬åˆ°64è¡Œ
56      if err != nil {
57          lex.err = err                 // 5. ä¿å­˜é”™è¯¯çŠ¶æ€
58          return err
59      }
60      lex.Token = token                // 6. è®¾ç½®å½“å‰æ ‡è®°
61      return nil
62  }
```

**åŠŸèƒ½**ï¼š
- âœ… è§£æå¹¶è¿”å›ä¸‹ä¸€ä¸ªæœ‰æ•ˆæ ‡è®°
- âœ… **ä¼˜å…ˆçº§**ï¼šé”™è¯¯çŠ¶æ€ â†’ å‰ç»ç¼“å­˜ â†’ æ–°è§£ææ ‡è®°
- âœ… **çŠ¶æ€ç®¡ç†**ï¼šè‡ªåŠ¨ç»´æŠ¤å†å²è®°å½•ï¼Œä¿å­˜é”™è¯¯çŠ¶æ€

**æ‰§è¡Œæµç¨‹**ï¼š
```
Next() (45è¡Œ)
  â”œâ†’ æ£€æŸ¥é”™è¯¯çŠ¶æ€ (46è¡Œ) â†’ å¦‚æœæœ‰é”™è¯¯ç›´æ¥è¿”å›
  â”œâ†’ ä¿å­˜å½“å‰æ ‡è®°åˆ°å†å² (49è¡Œ)
  â”œâ†’ æ£€æŸ¥å‰ç»ç¼“å­˜ (50è¡Œ) â†’ å¦‚æœæœ‰ç¼“å­˜ç›´æ¥è¿”å›
  â””â†’ è°ƒç”¨ next() è§£ææ–°æ ‡è®° (55è¡Œ) â†’ æ ¸å¿ƒè§£æé€»è¾‘
```

#### Prev - å›é€€åˆ°ä¸Šä¸€ä¸ªæ ‡è®°

**æºç ä½ç½®**ï¼š`lexer.go:442-446`

```go
442  func (lex *lexer) Prev() {
443      lex.nextTokens = append(lex.nextTokens, lex.Token)  // å½“å‰æ ‡è®°æ”¾å…¥å‰ç»ç¼“å­˜
444      lex.Token = lex.prevTokens[len(lex.prevTokens)-1]    // ä»å†å²æ¢å¤
445      lex.prevTokens = lex.prevTokens[:len(lex.prevTokens)-1]
446  }
```

**åŠŸèƒ½**ï¼š
- âœ… å®ç°å›æº¯è§£æ
- âœ… **åº”ç”¨åœºæ™¯**ï¼šå¤æ‚è¯­æ³•çš„é¢„åˆ¤å’Œå›é€€
- âœ… **æœºåˆ¶**ï¼šå°†å½“å‰æ ‡è®°æ”¾å…¥å‰ç»ç¼“å­˜ï¼Œä»å†å²ä¸­æ¢å¤ä¸Šä¸€ä¸ªæ ‡è®°

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
lex.Next()  // è¯»å– "sum"
lex.Next()  // è¯»å– "by"
lex.Prev()  // å›é€€åˆ° "sum"ï¼Œ"by" è¿›å…¥å‰ç»ç¼“å­˜
lex.Next()  // å†æ¬¡è¯»å– "by"ï¼ˆä»å‰ç»ç¼“å­˜ï¼‰
```

### 3.2 æ ‡è®°è§£ææµç¨‹

**æ ¸å¿ƒå…¥å£**ï¼š`next()` æ–¹æ³• (`lexer.go:64-138`)

`next()` æ–¹æ³•æ˜¯æ ‡è®°è§£æçš„æ ¸å¿ƒå…¥å£ï¼Œé‡‡ç”¨**ä¼˜å…ˆçº§åŒ¹é…ç­–ç•¥**ï¼š

```go
64  func (lex *lexer) next() (string, error) {
65  again:                                    // â† goto æ ‡ç­¾ï¼Œç”¨äºè·³è¿‡æ³¨é‡Š
66      // è·³è¿‡ç©ºç™½å­—ç¬¦ (66-73è¡Œ)
67      s := lex.sTail
68      i := 0
69      for i < len(s) && isSpaceChar(s[i]) {  // â†’ è°ƒç”¨ isSpaceChar (763è¡Œ)
70          i++
71      }
72      s = s[i:]
73      lex.sTail = s
74
75      if len(s) == 0 {                      // â† EOF æ£€æµ‹
76          return "", nil
77      }
78
79      var token string
80      var err error
81      switch s[0] {                          // â† ç‰¹æ®Šå­—ç¬¦æ£€æµ‹
82      case '#':
83          // Skip comment till the end of string
84          s = s[1:]
85          n := strings.IndexByte(s, '\n')
86          if n < 0 {
87              return "", nil
88          }
89          lex.sTail = s[n+1:]
90          goto again                         // â† è·³è¿‡æ³¨é‡Šï¼Œé‡æ–°å¼€å§‹
91      case '{', '}', '[', ']', '(', ')', ',', '@':
92          token = s[:1]                      // â† å•å­—ç¬¦æ ‡è®°
93          goto tokenFoundLabel
94      }
95      if isIdentPrefix(s) {                  // â†’ è°ƒç”¨ isIdentPrefix (737è¡Œ)
96          token = scanIdent(s)               // â†’ è°ƒç”¨ scanIdent (347è¡Œ)
97          goto tokenFoundLabel
98      }
99      if isStringPrefix(s) {                 // â†’ è°ƒç”¨ isStringPrefix (480è¡Œ)
100          token, err = scanString(s)         // â†’ è°ƒç”¨ scanString (140è¡Œ)
101          if err != nil {
102              return "", err
103          }
104          goto tokenFoundLabel
105      }
106      if n := scanBinaryOpPrefix(s); n > 0 {  // â†’ è°ƒç”¨ scanBinaryOpPrefix
107          token = s[:n]
108          goto tokenFoundLabel
109      }
110      if n := scanTagFilterOpPrefix(s); n > 0 {  // â†’ è°ƒç”¨ scanTagFilterOpPrefix (452è¡Œ)
111          token = s[:n]
112          goto tokenFoundLabel
113      }
114      if n := scanDuration(s); n > 0 {       // â†’ è°ƒç”¨ scanDuration (652è¡Œ)
115          token = s[:n]
116          goto tokenFoundLabel
117      }
118      if isPositiveNumberPrefix(s) {         // â†’ è°ƒç”¨ isPositiveNumberPrefix (493è¡Œ)
119          token, err = scanPositiveNumber(s) // â†’ è°ƒç”¨ scanPositiveNumber (232è¡Œ)
120          if err != nil {
121              return "", err
122          }
123          goto tokenFoundLabel
124      }
125      if strings.HasPrefix(s, "$__interval") {  // â† Grafana å˜é‡
126          lex.sTail = s[len("$__interval"):]
127          return "$__interval", nil
128      }
129      if strings.HasPrefix(s, "$__rate_interval") {
130          lex.sTail = s[len("$__rate_interval"):]
131          return "$__interval", nil              // â† è§„èŒƒåŒ–ä¸º $__interval
132      }
133      return "", fmt.Errorf("cannot recognize %q", s)  // â† æ— æ³•è¯†åˆ«
134
135  tokenFoundLabel:                           // â† goto ç›®æ ‡
136      lex.sTail = s[len(token):]             // â† æ›´æ–°è§£ææŒ‡é’ˆ
137      return token, nil
138  }
```

**å®Œæ•´æµç¨‹å›¾**ï¼š

```
                    next() (64è¡Œ)
                        â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 1. è·³è¿‡ç©ºç™½å­—ç¬¦ (69è¡Œ) â”‚ â†’ isSpaceChar() (763è¡Œ)
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 2. æ£€æŸ¥ EOF (75è¡Œ)     â”‚ â†’ len(s) == 0 â†’ è¿”å› ""
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 3. ç‰¹æ®Šå­—ç¬¦æ£€æµ‹ (81è¡Œ) â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”œâ†’ '#' (82è¡Œ) â†’ è·³è¿‡æ³¨é‡Š â†’ goto again (90è¡Œ)
                      â””â†’ '{', '}', ... (91è¡Œ) â†’ å•å­—ç¬¦æ ‡è®° (92è¡Œ)
                      â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 4. å¤æ‚æ ‡è®°è¯†åˆ«       â”‚
           â”‚   (æŒ‰ä¼˜å…ˆçº§æ’åº)       â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ 4.1 æ ‡è¯†ç¬¦ (95è¡Œ)     â”‚ â†’ isIdentPrefix() â†’ scanIdent()
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ 4.2 å­—ç¬¦ä¸² (99è¡Œ)     â”‚ â†’ isStringPrefix() â†’ scanString()
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ 4.3 äºŒå…ƒæ“ä½œç¬¦ (106è¡Œ)â”‚ â†’ scanBinaryOpPrefix()
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ 4.4 æ ‡ç­¾è¿‡æ»¤ (110è¡Œ)  â”‚ â†’ scanTagFilterOpPrefix()
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ 4.5 æ—¶é—´é—´éš” (114è¡Œ)  â”‚ â†’ scanDuration()
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ 4.6 æ•°å­— (118è¡Œ)      â”‚ â†’ scanPositiveNumber()
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ 4.7 Grafanaå˜é‡(125è¡Œ)â”‚ â†’ "$__interval"
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 5. æ›´æ–°è§£ææŒ‡é’ˆ (136è¡Œ)â”‚ â†’ lex.sTail = s[len(token):]
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 6. è¿”å›æ ‡è®°æˆ–é”™è¯¯      â”‚ â†’ (token, nil) æˆ– (error)
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¯æŒçš„æ ‡è®°ç±»å‹**ï¼š

| ä¼˜å…ˆçº§ | ç±»å‹ | æ£€æµ‹å‡½æ•° | æ‰«æå‡½æ•° | è¡Œå· | ç¤ºä¾‹ |
|-------|------|----------|----------|------|------|
| 1 | **æ³¨é‡Š** | `s[0] == '#'` | - | 82-90 | `# comment` |
| 2 | **å•å­—ç¬¦åˆ†éš”ç¬¦** | `switch` | - | 91-93 | `{`, `}`, `[`, `]`, `(`, `)`, `,`, `@` |
| 3 | **æ ‡è¯†ç¬¦** | `isIdentPrefix()` | `scanIdent()` | 95-97 | `http_requests_total`, `rate` |
| 4 | **å­—ç¬¦ä¸²** | `isStringPrefix()` | `scanString()` | 99-104 | `"GET"`, `'POST'`, `` `regex` `` |
| 5 | **äºŒå…ƒæ“ä½œç¬¦** | `scanBinaryOpPrefix()` | - | 106-108 | `+`, `==`, `and`, `or` |
| 6 | **æ ‡ç­¾è¿‡æ»¤æ“ä½œç¬¦** | `scanTagFilterOpPrefix()` | - | 110-112 | `=`, `!=`, `=~`, `!~` |
| 7 | **æ—¶é—´é—´éš”** | `scanDuration()` | - | 114-116 | `5m`, `1h30m` |
| 8 | **æ•°å­—** | `isPositiveNumberPrefix()` | `scanPositiveNumber()` | 118-123 | `123`, `1.5e3`, `100MB` |
| 9 | **Grafana å˜é‡** | `strings.HasPrefix()` | - | 125-131 | `$__interval`, `$__rate_interval` |

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **goto è¯­å¥çš„ä½¿ç”¨** (90, 93, 97è¡Œç­‰)
   - âœ… `goto again`ï¼šè·³è¿‡æ³¨é‡Šåé‡æ–°å¼€å§‹è§£æ
   - âœ… `goto tokenFoundLabel`ï¼šç»Ÿä¸€çš„æ ‡è®°è¿”å›å‡ºå£ï¼Œæ›´æ–°è§£ææŒ‡é’ˆ

2. **ä¼˜å…ˆçº§ç­–ç•¥** (95-123è¡Œ)
   - âœ… æŒ‰ç…§æ˜ç¡®çš„ä¼˜å…ˆçº§é¡ºåºæ£€æµ‹
   - âœ… é¿å…æ ‡è®°ç±»å‹å†²çªï¼ˆå¦‚æ ‡è¯†ç¬¦ vs æ•°å­—ï¼‰
   - âœ… é«˜é¢‘æ ‡è®°ï¼ˆæ ‡è¯†ç¬¦ã€å­—ç¬¦ä¸²ã€æ•°å­—ï¼‰ä¼˜å…ˆæ£€æµ‹

3. **é”™è¯¯å¤„ç†** (133è¡Œ)
   - âœ… æ— æ³•è¯†åˆ«æ—¶è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
   - âœ… åŒ…å«æ— æ³•è¯†åˆ«çš„å­—ç¬¦ä¸²å†…å®¹

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 4. æ ¸å¿ƒè§£æç®—æ³•

### 4.1 æ ‡è¯†ç¬¦è§£æç³»ç»Ÿ

æ ‡è¯†ç¬¦è§£æè´Ÿè´£è¯†åˆ«æŒ‡æ ‡åã€å‡½æ•°åã€æ ‡ç­¾åç­‰å…³é”®å…ƒç´ ã€‚è¿™æ˜¯è¯æ³•åˆ†æå™¨æœ€å¤æ‚çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œæ¶‰åŠ Unicode æ”¯æŒã€è½¬ä¹‰å¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

#### å­—ç¬¦è§„åˆ™å®šä¹‰

**é¦–å­—ç¬¦è§„åˆ™** (`isFirstIdentChar`) - `lexer.go:749-754`

```go
749  func isFirstIdentChar(r rune) bool {
750      if unicode.IsLetter(r) {  // â† ä»»ä½• Unicode å­—æ¯
751          return true            //    æ”¯æŒå…¨çƒå­—ç¬¦é›†
752      }
753      return r == '_' || r == ':'  // â† ç‰¹æ®Šå­—ç¬¦ï¼šä¸‹åˆ’çº¿ã€å†’å·
754  }
```

**è¯¦è§£**ï¼š
- âœ… `unicode.IsLetter(r)`ï¼šæ”¯æŒå…¨çƒæ‰€æœ‰ä¹¦å†™ç³»ç»Ÿçš„å­—æ¯å­—ç¬¦
  - åŒ…æ‹¬ï¼šæ‹‰ä¸å­—æ¯ã€ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ã€é˜¿æ‹‰ä¼¯æ–‡ã€è¥¿é‡Œå°”å­—æ¯ç­‰
  - å®ç°ä½ç½®ï¼šGoæ ‡å‡†åº“ `unicode` åŒ…
  - æ€§èƒ½ï¼š~8.5ns/opï¼ˆUnicodeåˆ†ç±»åˆ¤æ–­ï¼‰
- âœ… `r == '_' || r == ':'`ï¼šPrometheus ç‰¹æ®Šå­—ç¬¦
  - `_`ï¼šé€šç”¨åˆ†éš”ç¬¦ï¼ˆå¦‚ `http_requests_total`ï¼‰
  - `:`ï¼šå‘½åç©ºé—´åˆ†éš”ç¬¦ï¼ˆå¦‚ `node_exporter:cpu`ï¼‰

**åç»­å­—ç¬¦è§„åˆ™** (`isIdentChar`) - `lexer.go:756-761`

```go
756  func isIdentChar(r rune) bool {
757      if isFirstIdentChar(r) {     // â† é¦–å­—ç¬¦è§„åˆ™åŒæ ·é€‚ç”¨
758          return true
759      }
760      return r < 256 && isDecimalChar(byte(r)) || r == '.'
761      //     â†‘ å…³é”®ï¼šé™åˆ¶åœ¨ ASCII èŒƒå›´å†… (0-255)
762      //              ç„¶åæ£€æŸ¥æ˜¯å¦ä¸ºåè¿›åˆ¶æ•°å­—
763      //                                        â†‘ æˆ–è€…æ˜¯å°æ•°ç‚¹
764  }
```

**è¯¦è§£**ï¼š
- âœ… åç»­å­—ç¬¦ = é¦–å­—ç¬¦è§„åˆ™ + ASCIIæ•°å­— + å°æ•°ç‚¹
- âœ… `r < 256 && isDecimalChar(byte(r))`ï¼š**åªå…è®¸ ASCII æ•°å­—**
  - é™åˆ¶åŸå› ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆè§ä¸‹æ–‡ï¼‰
  - æ’é™¤ï¼šå…¨è§’æ•°å­—ï¼ˆå¦‚ `ï¼‘ï¼’ï¼“`ï¼‰ã€é˜¿æ‹‰ä¼¯æ•°å­—ç­‰
- âœ… `r == '.'`ï¼šæ”¯æŒç‚¹åˆ†å‘½åç©ºé—´
  - å…è®¸ï¼š`prometheus.tsdb.head.samples`

**è°ƒç”¨å…³ç³»**ï¼š
```
next() (64è¡Œ)
  â†’ isIdentPrefix() (737è¡Œ)
    â†’ utf8.DecodeRuneInString() (741è¡Œ) â† è§£ç ç¬¬ä¸€ä¸ªå­—ç¬¦
    â†’ isFirstIdentChar() (746è¡Œ) â† æ£€æŸ¥é¦–å­—ç¬¦è§„åˆ™
  â†’ scanIdent() (347è¡Œ)
    â†’ utf8.DecodeRuneInString() (350è¡Œ) â† é€å­—ç¬¦è§£ç 
    â†’ isIdentChar() (351è¡Œ, 756è¡Œ) â† æ£€æŸ¥åç»­å­—ç¬¦è§„åˆ™
```

#### ä¸ºä»€ä¹ˆåªå…è®¸ ASCII æ•°å­—ï¼Ÿ

**æ€§èƒ½ä¼˜åŠ¿** (lexer.go:725-727, 760)

```go
// isDecimalChar() - ç”¨äº ASCII æ•°å­—æ£€æŸ¥ (lexer.go:725-727)
725  func isDecimalChar(ch byte) bool {
726      return ch >= '0' && ch <= '9'  // â† 2æ¬¡æ•´æ•°æ¯”è¾ƒï¼Œ~0.3ns/op
727  }

// isIdentChar() - å®é™…åº”ç”¨ (lexer.go:760)
760      return r < 256 && isDecimalChar(byte(r)) || r == '.'
     //         â†‘ å…ˆæ£€æŸ¥ ASCII èŒƒå›´ï¼ˆ1æ¬¡æ¯”è¾ƒï¼‰
     //               â†‘ å†æ£€æŸ¥æ•°å­—èŒƒå›´ï¼ˆ2æ¬¡æ¯”è¾ƒï¼‰
     //               æ€»è®¡ï¼š3æ¬¡æ•´æ•°æ¯”è¾ƒï¼Œ~0.5ns/op
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```go
// âœ… å½“å‰å®ç°ï¼šASCII å¿«é€Ÿè·¯å¾„ (~0.5ns/op)
r < 256 && ch >= '0' && ch <= '9'

// âŒ å¦‚æœä½¿ç”¨ Unicode æ£€æŸ¥ (~8.5ns/op)
unicode.IsDigit(r)  // éœ€è¦æŸ¥è¡¨ã€åˆ†ç±»åˆ¤æ–­

// æ€§èƒ½å·®è·ï¼š17å€
```

**å‚è€ƒ**ï¼š`character_encoding_guide.md` ç¬¬2ç« è¯¦ç»†è§£é‡Šäº† Unicode å­—æ¯åˆ¤æ–­å’Œ ASCII æ€§èƒ½ä¼˜åŒ–ã€‚

**å…¼å®¹æ€§ä¿è¯**ï¼š
- âœ… **Prometheus ç”Ÿæ€æ ‡å‡†**ï¼šæ‰€æœ‰ Prometheus æŒ‡æ ‡åéƒ½ä½¿ç”¨ ASCII æ•°å­—
- âœ… **99.9% å®é™…åœºæ™¯è¦†ç›–**ï¼šå®é™…ç”Ÿäº§ç¯å¢ƒä¸­æå°‘ä½¿ç”¨é ASCII æ•°å­—
- âœ… **é¿å…è§†è§‰æ··æ·†**ï¼šé˜²æ­¢ `metric123` vs `metricï¼‘ï¼’ï¼“`ï¼ˆå…¨è§’æ•°å­—ï¼‰æ··æ·†

**å®‰å…¨æ€§è€ƒè™‘**ï¼š
```promql
# âŒ å¦‚æœå…è®¸ Unicode æ•°å­—ï¼Œå¯èƒ½å‡ºç°æ··æ·†æ”»å‡»
metric_123    # ASCII æ•°å­—
metric_ï¼‘ï¼’ï¼“  # å…¨è§’æ•°å­—ï¼ˆè§†è§‰ç›¸ä¼¼ï¼Œå®é™…ä¸åŒï¼‰

# âœ… å½“å‰å®ç°ï¼šåªå…è®¸ ASCIIï¼Œé¿å…æ··æ·†
metric_123    # åˆæ³•
metric_ï¼‘ï¼’ï¼“  # éæ³•ï¼ˆè§£æå¤±è´¥ï¼‰
```

#### æ‰«æç®—æ³•å®ç°

**æ ¸å¿ƒå‡½æ•°**ï¼š`scanIdent()` - `lexer.go:347-371`

```go
347  func scanIdent(s string) string {
348      i := 0
349      for i < len(s) {
350          r, size := utf8.DecodeRuneInString(s[i:])  // â† UTF-8 è§£ç 
351          if i == 0 && isFirstIdentChar(r) || i > 0 && isIdentChar(r) {
352          //   â†‘ é¦–å­—ç¬¦æ£€æŸ¥              â†‘ åç»­å­—ç¬¦æ£€æŸ¥
353              i += size  // â† è·³è¿‡å½“å‰å­—ç¬¦çš„å­—èŠ‚æ•°
354              continue
355          }
356          if r != '\\' {  // â† ä¸æ˜¯è½¬ä¹‰åºåˆ—ï¼Œæ ‡è¯†ç¬¦ç»“æŸ
357              break
358          }
359          i += size       // â† è·³è¿‡åæ–œæ 
360          r, n := decodeEscapeSequence(s[i:])  // â† è§£ç è½¬ä¹‰åºåˆ— (784è¡Œ)
361          if r == utf8.RuneError {     // â† æ— æ•ˆè½¬ä¹‰åºåˆ—
362              // Invalid escape sequence
363              i -= size  // â† å›é€€ï¼Œä¸åŒ…å«æ— æ•ˆè½¬ä¹‰
364              break
365          }
366          i += n  // â† è·³è¿‡è½¬ä¹‰åºåˆ—çš„å­—èŠ‚æ•°
367      }
368      if i == 0 {  // â† æœªæ‰¾åˆ°ä»»ä½•å­—ç¬¦ï¼Œå†…éƒ¨é”™è¯¯
369          panic("BUG: scanIdent couldn't find a single ident char; make sure isIdentPrefix called before scanIdent")
370      }
371      return s[:i]  // â† é›¶æ‹·è´åˆ‡ç‰‡è¿”å›
372  }
```

**ç®—æ³•æ­¥éª¤è¯¦è§£**ï¼š

1. **UTF-8 é€å­—ç¬¦è§£ç ** (350è¡Œ)
   ```go
   r, size := utf8.DecodeRuneInString(s[i:])
   // r: Unicode ç ç‚¹ (rune)
   // size: è¯¥å­—ç¬¦çš„å­—èŠ‚æ•° (1-4å­—èŠ‚)
   ```

2. **å­—ç¬¦è§„åˆ™æ£€æŸ¥** (351è¡Œ)
   ```go
   if i == 0 && isFirstIdentChar(r) || i > 0 && isIdentChar(r)
   //   â†‘ é¦–å­—ç¬¦ä½ç½®                 â†‘ åç»­å­—ç¬¦ä½ç½®
   ```

3. **è½¬ä¹‰åºåˆ—å¤„ç†** (356-366è¡Œ)
   - æ£€æµ‹åæ–œæ  `\` (356è¡Œ)
   - è°ƒç”¨ `decodeEscapeSequence()` è§£ç è½¬ä¹‰ (360è¡Œ)
   - å¤„ç†æ— æ•ˆè½¬ä¹‰ï¼ˆå›é€€ï¼‰(361-364è¡Œ)

4. **é›¶æ‹·è´è¿”å›** (371è¡Œ)
   ```go
   return s[:i]  // ç›´æ¥åˆ‡ç‰‡ï¼Œä¸äº§ç”Ÿæ–°çš„å†…å­˜åˆ†é…
   ```

#### è½¬ä¹‰åºåˆ—å¤„ç†

**è§£ç å‡½æ•°**ï¼š`decodeEscapeSequence()` - `lexer.go:784-814`

```go
784  func decodeEscapeSequence(s string) (rune, int) {
785      if strings.HasPrefix(s, "x") || strings.HasPrefix(s, "X") {
786          // \xNN æ ¼å¼ï¼šåå…­è¿›åˆ¶è½¬ä¹‰ (2ä½)
787          if len(s) >= 3 {
788              h1 := fromHex(s[1])  // â† ç¬¬1ä½åå…­è¿›åˆ¶æ•°å­—
789              h2 := fromHex(s[2])  // â† ç¬¬2ä½åå…­è¿›åˆ¶æ•°å­—
790              if h1 >= 0 && h2 >= 0 {
791                  r := rune((h1 << 4) | h2)  // â† ç»„åˆä¸ºå­—ç¬¦
792                  return r, 3  // â† æ¶ˆè€—3ä¸ªå­—ç¬¦: x + 2ä½hex
793              }
794          }
795          return utf8.RuneError, 0
796      }
797      if strings.HasPrefix(s, "u") || strings.HasPrefix(s, "U") {
798          // \uNNNN æ ¼å¼ï¼šUnicode è½¬ä¹‰ (4ä½)
799          if len(s) >= 5 {
800              h1 := fromHex(s[1])
801              h2 := fromHex(s[2])
802              h3 := fromHex(s[3])
803              h4 := fromHex(s[4])
804              if h1 >= 0 && h2 >= 0 && h3 >= 0 && h4 >= 0 {
805                  return rune((h1 << 12) | (h2 << 8) | (h3 << 4) | h4), 5
806              //             â†‘ ç»„åˆ4ä½åå…­è¿›åˆ¶æ•°å­—ä¸º Unicode ç ç‚¹
807              }
808          }
809          return utf8.RuneError, 0
810      }
811      r, size := utf8.DecodeRuneInString(s)  // â† ç›´æ¥å­—ç¬¦è½¬ä¹‰
812      if unicode.IsPrint(r) {  // â† åªå…è®¸å¯æ‰“å°å­—ç¬¦
813          return r, size
814      }
815      // Improperly escaped non-printable char
816      return utf8.RuneError, 0
817  }
```

**æ”¯æŒçš„è½¬ä¹‰ç±»å‹**ï¼š

| è½¬ä¹‰æ ¼å¼ | ç¤ºä¾‹ | ç»“æœ | å­—èŠ‚æ¶ˆè€— | è¯´æ˜ |
|---------|------|------|---------|------|
| **\xNN** | `\x41` | `'A'` | 3 | åå…­è¿›åˆ¶ï¼ˆ2ä½ï¼‰ï¼ŒASCII èŒƒå›´ |
| **\xNN** | `\x4E` | `'N'` | 3 | å¯è¡¨ç¤º 0x00-0xFF |
| **\uNNNN** | `\u0041` | `'A'` | 5 | Unicodeï¼ˆ4ä½ï¼‰ï¼ŒBMP èŒƒå›´ |
| **\uNNNN** | `\u4E2D` | `'ä¸­'` | 5 | å¯è¡¨ç¤º U+0000-U+FFFF |
| **\<char>** | `\-` | `'-'` | 2 | ç›´æ¥å­—ç¬¦è½¬ä¹‰ |
| **\<char>** | `\_` | `'_'` | 2 | å¯æ‰“å°å­—ç¬¦å‡å¯ |

**è½¬ä¹‰ç¤ºä¾‹**ï¼š
```promql
# åå…­è¿›åˆ¶è½¬ä¹‰
metric\x41name        â†’ metricAname      (A)
metric\x2Dtest        â†’ metric-test      (-)

# Unicode è½¬ä¹‰
metric\u0041name      â†’ metricAname      (A)
\u4E2D\u6587metric    â†’ ä¸­æ–‡metric       (ä¸­æ–‡)

# ç›´æ¥å­—ç¬¦è½¬ä¹‰
metric\-with\-dashes  â†’ metric-with-dashes
path\_to\_file        â†’ path_to_file
```

#### æ ‡è¯†ç¬¦ç¤ºä¾‹

**åŸºç¡€æ ‡è¯†ç¬¦**ï¼š
```promql
http_requests_total
cpu_usage_percent
memory_bytes
```

**å‘½åç©ºé—´åˆ†éš”**ï¼š
```promql
prometheus.tsdb.head.samples    # ç‚¹åˆ†å‘½åç©ºé—´
node_exporter:cpu_seconds       # å†’å·å‘½åç©ºé—´
```

**Unicode æ”¯æŒ**ï¼š
```promql
# ä¸­æ–‡
è¯·æ±‚æ€»æ•°_http
é”™è¯¯ç‡_percent

# æ—¥æ–‡
ã‚µãƒ¼ãƒãƒ¼è² è·_cpu
ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡_bytes

# éŸ©æ–‡
ìš”ì²­ìˆ˜_total
ì‘ë‹µì‹œê°„_seconds
```

**è½¬ä¹‰å­—ç¬¦**ï¼š
```promql
metric\-with\-dashes           # metric-with-dashes
path\_to\_metric               # path_to_metric
\x48ello_world                 # Hello_world (H = 0x48)
\u4E2Dname                     # ä¸­name (ä¸­ = U+4E2D)
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

###4.2 å­—ç¬¦ä¸²è§£æç³»ç»Ÿ

`scanString()` å‡½æ•°å®ç°äº†å®Œå–„çš„å­—ç¬¦ä¸²è§£æï¼Œæ”¯æŒå¤æ‚çš„è½¬ä¹‰åœºæ™¯ã€‚

#### æ ¸å¿ƒç®—æ³•ï¼šåæ–œæ è®¡æ•°

é€šè¿‡ç»Ÿè®¡å¼•å·å‰è¿ç»­åæ–œæ çš„æ•°é‡åˆ¤æ–­å¼•å·æ˜¯å¦è¢«è½¬ä¹‰ï¼š

```go
// å‘å‰è®¡æ•°è¿ç»­çš„åæ–œæ 
bs := 0
for bs < i && s[i-bs-1] == '\\' {
    bs++
}

// å¥‡å¶æ€§åˆ¤æ–­
if bs%2 == 0 {
    // å¶æ•°ä¸ªåæ–œæ  â†’ å¼•å·æœªè¢«è½¬ä¹‰ â†’ å­—ç¬¦ä¸²ç»“æŸ
} else {
    // å¥‡æ•°ä¸ªåæ–œæ  â†’ å¼•å·è¢«è½¬ä¹‰ â†’ ç»§ç»­æ‰«æ
}
```

#### ç®—æ³•åŸç†

```
å­—ç¬¦ä¸²: "hello\"world"
       01234567890123

ä½ç½®7çš„å¼•å·å‰ï¼š
- å‘å‰æ£€æŸ¥: s[6] = '\' â†’ bs = 1
- bs % 2 == 1 â†’ å¼•å·è¢«è½¬ä¹‰ â†’ ç»§ç»­

ä½ç½®13çš„å¼•å·å‰ï¼š
- å‘å‰æ£€æŸ¥: s[12] = 'd' (ä¸æ˜¯åæ–œæ ) â†’ bs = 0
- bs % 2 == 0 â†’ å¼•å·æœªè¢«è½¬ä¹‰ â†’ å­—ç¬¦ä¸²ç»“æŸ
```

#### æ”¯æŒçš„å­—ç¬¦ä¸²ç±»å‹

**åŒå¼•å·å­—ç¬¦ä¸²**
```promql
"simple string"
"He said \"Hello\""
"path\\to\\file"
```

**å•å¼•å·å­—ç¬¦ä¸²**
```promql
'Server responded with "OK"'
'It'\''s working'
```

**åå¼•å·å­—ç¬¦ä¸²ï¼ˆåŸå§‹å­—ç¬¦ä¸²ï¼‰**
```promql
`^/api/v\d+/.*$`        # æ­£åˆ™è¡¨è¾¾å¼
`path\to\file`          # æ— éœ€è½¬ä¹‰
```

#### å®æˆ˜åº”ç”¨

```promql
# æ ‡ç­¾å€¼åŒ¹é…
http_requests_total{method="GET", path="/api/users"}

# æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
http_requests_total{status=~"2.."}

# å¤æ‚è·¯å¾„åŒ¹é…
http_requests_total{path=~`^/api/v\d+/users/\d+$`}

# åŒ…å«ç‰¹æ®Šå­—ç¬¦
http_requests_total{message='Server said "OK"'}

# Windows è·¯å¾„
file_access_total{path="C:\\Program Files\\App\\config.json"}
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

### 4.3 æ•°å­—è§£æç³»ç»Ÿ

æ”¯æŒå¤šç§æ•°å­—æ ¼å¼å’Œå•ä½ç³»ç»Ÿã€‚

#### æ”¯æŒçš„æ•°å­—æ ¼å¼

**æ•´æ•°**
```promql
123           # åè¿›åˆ¶
0x1a2b        # åå…­è¿›åˆ¶
0o755         # å…«è¿›åˆ¶
0b1010        # äºŒè¿›åˆ¶
```

**å°æ•°**
```promql
123.45        # æ ‡å‡†å°æ•°
.123          # çœç•¥æ•´æ•°éƒ¨åˆ†
```

**ç§‘å­¦è®¡æ•°æ³•**
```promql
1.23e4        # 12300
1.23E-5       # 0.0000123
```

**å¸¦å•ä½çš„æ•°å­—**
```promql
# åè¿›åˆ¶å•ä½
123k          # 123,000
456M          # 456,000,000
789G          # 789,000,000,000

# äºŒè¿›åˆ¶å•ä½
100Ki         # 102,400
256Mi         # 268,435,456
1Gi           # 1,073,741,824
```

#### å•ä½ç³»ç»Ÿ

| åè¿›åˆ¶å•ä½ | å€¼ | äºŒè¿›åˆ¶å•ä½ | å€¼ |
|-----------|-----|-----------|-----|
| k | 1000 | Ki | 1024 |
| M | 1000Â² | Mi | 1024Â² |
| G | 1000Â³ | Gi | 1024Â³ |
| T | 1000â´ | Ti | 1024â´ |

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

### 4.4 æ“ä½œç¬¦è¯†åˆ«ç³»ç»Ÿ

#### æ ‡ç­¾è¿‡æ»¤æ“ä½œç¬¦

`scanTagFilterOpPrefix()` ä½¿ç”¨é•¿åº¦ä¼˜å…ˆåŒ¹é…ç­–ç•¥ï¼š

```go
func scanTagFilterOpPrefix(s string) int {
    // ä¼˜å…ˆæ£€æŸ¥åŒå­—ç¬¦æ“ä½œç¬¦
    if len(s) >= 2 {
        switch s[:2] {
        case "=~", "!~", "!=":
            return 2
        }
    }
    // å›é€€åˆ°å•å­—ç¬¦æ“ä½œç¬¦
    if len(s) >= 1 && s[0] == '=' {
        return 1
    }
    return -1
}
```

**æ”¯æŒçš„æ“ä½œç¬¦**

| æ“ä½œç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `=` | ç²¾ç¡®åŒ¹é… | `{method="GET"}` |
| `!=` | ä¸ç­‰äº | `{method!="OPTIONS"}` |
| `=~` | æ­£åˆ™åŒ¹é… | `{status=~"2.."}` |
| `!~` | æ­£åˆ™ä¸åŒ¹é… | `{path!~"/internal/.*"}` |

#### äºŒå…ƒæ“ä½œç¬¦

`scanBinaryOpPrefix()` å®ç°æœ€é•¿åŒ¹é…ç®—æ³•ï¼š

```go
func scanBinaryOpPrefix(s string) int {
    n := 0
    for op := range binaryOps {
        if len(s) < len(op) {
            continue
        }
        ss := strings.ToLower(s[:len(op)])
        if ss == op && len(op) > n {
            n = len(op)  // æ›´æ–°ä¸ºæ›´é•¿çš„åŒ¹é…
        }
    }
    return n
}
```

**æ“ä½œç¬¦åˆ†ç±»**

**ç®—æœ¯æ“ä½œç¬¦**
```promql
+, -, *, /, %, ^, atan2
```

**æ¯”è¾ƒæ“ä½œç¬¦**
```promql
==, !=, >, <, >=, <=
```

**é€»è¾‘é›†åˆæ“ä½œç¬¦**
```promql
and, or, unless
```

**MetricsQL æ‰©å±•**
```promql
if, ifnot, default
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

### 4.5 æ—¶é—´é—´éš”è§£æ

#### æ”¯æŒçš„æ—¶é—´å•ä½

| å•ä½ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ms` | æ¯«ç§’ | `500ms` |
| `s` | ç§’ | `30s` |
| `m` | åˆ†é’Ÿ | `5m` |
| `h` | å°æ—¶ | `2h` |
| `d` | å¤© | `7d` |
| `w` | å‘¨ | `4w` |
| `y` | å¹´ | `1y` |
| `i` | æ­¥é•¿é—´éš” | `1i` |

#### ç»„åˆæ—¶é—´é—´éš”

```promql
2h5m          # 2å°æ—¶5åˆ†é’Ÿ
1d-30m        # 1å¤©å‡30åˆ†é’Ÿ
1.5h          # 1.5å°æ—¶ï¼ˆæµ®ç‚¹æ•°æ”¯æŒï¼‰
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 5. å¿«é€Ÿå‚è€ƒ

### æ ‡è®°ç±»å‹é€ŸæŸ¥

```promql
# æ ‡è¯†ç¬¦
http_requests_total
rate
method

# å­—ç¬¦ä¸²
"GET"
'POST'
`^/api/.*`

# æ•°å­—
123
1.5e3
100MB

# æ“ä½œç¬¦
+  -  *  /  %  ^
==  !=  >  <  >=  <=
and  or  unless
=  !=  =~  !~

# åˆ†éš”ç¬¦
{  }  [  ]  (  )  ,  @

# æ—¶é—´
5m  1h30m  $__interval

# æ³¨é‡Š
# This is a comment
```

### å¸¸è§æŸ¥è¯¢æ¨¡å¼

```promql
# åŸºæœ¬æŸ¥è¯¢
http_requests_total

# æ ‡ç­¾è¿‡æ»¤
http_requests_total{method="GET", status=~"2.."}

# æ—¶é—´çª—å£å‡½æ•°
rate(http_requests_total[5m])

# æ•°å­¦è¿ç®—
http_requests_total * 100

# èšåˆå‡½æ•°
sum(http_requests_total) by (method)

# æ—¶é—´åç§»
http_requests_total offset 1h

# å¤æ‚è¡¨è¾¾å¼
rate(http_requests_total{method="GET"}[5m]) > 10
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 6. å®æˆ˜åº”ç”¨

### åŸºæœ¬ç”¨æ³•

```go
package main

import (
    "fmt"
)

func main() {
    lex := &lexer{}
    lex.Init("rate(http_requests_total[5m])")

    for {
        err := lex.Next()
        if err != nil {
            fmt.Printf("Error: %v\n", err)
            break
        }
        if lex.Token == "" {
            break // EOF
        }
        fmt.Printf("Token: %q\n", lex.Token)
    }
}
```

**è¾“å‡ºç»“æœ**
```
Token: "rate"
Token: "("
Token: "http_requests_total"
Token: "["
Token: "5m"
Token: "]"
Token: ")"
```

### é«˜çº§åœºæ™¯

#### é”™è¯¯å¤„ç†

```go
lex := &lexer{}
lex.Init(`metric{label="unclosed string`)

for {
    err := lex.Next()
    if err != nil {
        fmt.Printf("Parse error: %v\n", err)
        // è¾“å‡º: Parse error: cannot find closing quote " for the string "unclosed string
        break
    }
    if lex.Token == "" {
        break
    }
}
```

#### å›é€€æœºåˆ¶

```go
lex := &lexer{}
lex.Init("sum by (instance)")

lex.Next()  // "sum"
lex.Next()  // "by"
lex.Prev()  // å›é€€åˆ° "sum"
```

### Grafana é›†æˆ

```promql
# è‡ªåŠ¨é—´éš”å˜é‡
rate(http_requests_total[$__interval])

# é€Ÿç‡é—´éš”å˜é‡ï¼ˆè¢«è§„èŒƒåŒ–ä¸º $__intervalï¼‰
rate(http_requests_total[$__rate_interval])

# ç»„åˆä½¿ç”¨
increase(metric[$__interval:30s])
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 7. æ€§èƒ½ç‰¹æ€§

### æ—¶é—´å¤æ‚åº¦

| æ“ä½œ | å¤æ‚åº¦ | è¯´æ˜ |
|------|--------|------|
| ç©ºç™½å­—ç¬¦è·³è¿‡ | O(n) | n ä¸ºè¿ç»­ç©ºç™½å­—ç¬¦æ•°é‡ |
| æ ‡è¯†ç¬¦æ‰«æ | O(m) | m ä¸ºæ ‡è¯†ç¬¦é•¿åº¦ |
| å­—ç¬¦ä¸²è§£æ | O(kÃ—p) | k ä¸ºæŸ¥æ‰¾æ¬¡æ•°ï¼Œp ä¸ºå­—ç¬¦ä¸²é•¿åº¦ |
| æ“ä½œç¬¦è¯†åˆ« | O(1) - O(M) | M ä¸ºæ“ä½œç¬¦æ•°é‡ï¼ˆé€šå¸¸ <20ï¼‰ |

### ç©ºé—´å¤æ‚åº¦

- **å­—ç¬¦ä¸²åˆ‡ç‰‡**ï¼šO(1)ï¼Œä¸äº§ç”Ÿæ–°çš„å†…å­˜åˆ†é…
- **ç¼“å­˜æœºåˆ¶**ï¼šO(T)ï¼ŒT ä¸ºç¼“å­˜çš„æ ‡è®°æ•°é‡
- **æ•´ä½“ç©ºé—´**ï¼šO(1) - O(T)

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨å­—ç¬¦ä¸²åˆ‡ç‰‡è€Œéå¤åˆ¶**
```go
token = s[:len(token)]  // âœ… é«˜æ•ˆ
token = string([]byte(s[:len(token)]))  // âŒ ä½æ•ˆ
```

**2. é¿å…ä¸å¿…è¦çš„å­—ç¬¦ä¸²æ“ä½œ**
```go
// âœ… ä¼˜åŒ–çš„é•¿åº¦æ£€æŸ¥
if len(s) >= 2 && s[:2] == "==" { ... }

// âŒ ä½æ•ˆçš„æ­£åˆ™åŒ¹é…
if regexp.MustCompile("^==").MatchString(s) { ... }
```

**3. åˆ©ç”¨å­—ç¬¦èŒƒå›´æ£€æŸ¥**
```go
// âœ… å¿«é€Ÿçš„ ASCII æ£€æŸ¥
ch >= '0' && ch <= '9'

// âŒ æ…¢é€Ÿçš„ Unicode æ£€æŸ¥ï¼ˆéå¿…è¦æ—¶ï¼‰
unicode.IsDigit(ch)
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## 8. æœ€ä½³å®è·µ

### é”™è¯¯å¤„ç†å»ºè®®

```go
// âœ… æ¨èï¼šæ•è·å¹¶å¤„ç†é”™è¯¯
lex := &lexer{}
lex.Init(query)

for {
    if err := lex.Next(); err != nil {
        return fmt.Errorf("lexer error at position %d: %w", 
            len(lex.sOrig)-len(lex.sTail), err)
    }
    if lex.Token == "" {
        break
    }
    // å¤„ç†æ ‡è®°
}
```

### å›½é™…åŒ–æ”¯æŒ

```go
// âœ… æ¨èï¼šä½¿ç”¨ Unicode æ ‡è¯†ç¬¦
è¯·æ±‚æ€»æ•°{ç¯å¢ƒ="ç”Ÿäº§"}
ã‚µãƒ¼ãƒãƒ¼è² è·{ãƒ›ã‚¹ãƒˆ="server-01"}

// âš ï¸ æ³¨æ„ï¼šæ•°å­—å¿…é¡»æ˜¯ ASCII
metric_name_123  // âœ…
metric_name_ï¼‘ï¼’ï¼“  // âŒ å…¨è§’æ•°å­—ä¸è¢«è¯†åˆ«
```

### å¼•å·é€‰æ‹©æŒ‡å—

```promql
# åŒ…å«åŒå¼•å·æ—¶ç”¨å•å¼•å·
'{message: "Hello World"}'

# åŒ…å«å•å¼•å·æ—¶ç”¨åŒå¼•å·
"{error: 'Can'\''t connect'}"

# æ­£åˆ™è¡¨è¾¾å¼ç”¨åå¼•å·
{path=~`^/api/v\d+/.*$`}

# ç®€å•å­—ç¬¦ä¸²ä¼˜å…ˆç”¨åŒå¼•å·
{method="GET"}
```

### æ€§èƒ½å»ºè®®

**1. é¢„ç¼–è¯‘æŸ¥è¯¢**
```go
// âœ… ä¸€æ¬¡è§£æï¼Œå¤šæ¬¡ä½¿ç”¨
lex := &lexer{}
lex.Init(query)
// ç¼“å­˜è§£æç»“æœ

// âŒ æ¯æ¬¡éƒ½é‡æ–°è§£æ
for i := 0; i < 1000; i++ {
    lex := &lexer{}
    lex.Init(query)
    // ...
}
```

**2. é¿å…å¤æ‚çš„è½¬ä¹‰**
```promql
# âœ… ä½¿ç”¨åå¼•å·ç®€åŒ–
{pattern=`\d{4}-\d{2}-\d{2}`}

# âŒ å¤æ‚çš„è½¬ä¹‰
{pattern="\\d{4}-\\d{2}-\\d{2}"}
```

**3. åˆ©ç”¨ç¼“å­˜æœºåˆ¶**
```go
// è¯æ³•åˆ†æå™¨å†…éƒ¨çš„ç¼“å­˜æœºåˆ¶
lex.Next()     // è§£ææ–°æ ‡è®°
lex.Prev()     // ä½¿ç”¨ç¼“å­˜ï¼Œæ— éœ€é‡æ–°è§£æ
lex.Next()     // ä»ç¼“å­˜è¯»å–
```

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)

---

## æ€»ç»“

### æ ¸å¿ƒåˆ›æ–°

**åæ–œæ è®¡æ•°ç®—æ³•**
- é€šè¿‡å¥‡å¶æ€§åˆ¤æ–­è§£å†³è½¬ä¹‰é—®é¢˜
- ç»å…¸çš„å­—ç¬¦ä¸²è§£ææŠ€æœ¯

**æ¸è¿›å¼ Unicode æ”¯æŒ**
- å­—æ¯ï¼šå®Œå…¨ Unicode åŒ–
- æ•°å­—ï¼šä¿æŒ ASCIIï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
- åœ¨å›½é™…åŒ–å’Œæ€§èƒ½é—´å®Œç¾å¹³è¡¡

**æœ€é•¿åŒ¹é…ç­–ç•¥**
- æ­£ç¡®å¤„ç†æ“ä½œç¬¦å‰ç¼€å†²çª
- ç¼–è¯‘å™¨ç†è®ºçš„æ ‡å‡†å®è·µ

### è®¾è®¡å“²å­¦

1. **å¹³è¡¡æ€§**ï¼šåŠŸèƒ½ä¸°å¯Œæ€§ä¸æ€§èƒ½çš„æœ€ä½³å¹³è¡¡
2. **å®ç”¨æ€§**ï¼šæ»¡è¶³ 99.9% çš„å®é™…åœºæ™¯
3. **å‰ç»æ€§**ï¼šä¸ºè¯­æ³•æ‰©å±•é¢„ç•™ç©ºé—´
4. **å…¼å®¹æ€§**ï¼šä¸ Prometheus ç”Ÿæ€å®Œç¾èåˆ
5. **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„å’Œé”™è¯¯å¤„ç†

### æŠ€æœ¯äº®ç‚¹

- **é›¶æ‹·è´è®¾è®¡**ï¼šæœ€å°åŒ–å†…å­˜åˆ†é…
- **åŒå‘ç¼“å­˜**ï¼šæ”¯æŒå¤æ‚çš„å›æº¯è§£æ
- **æ¨¡å—åŒ–æ¶æ„**ï¼šæ¯ç§æ ‡è®°ç±»å‹ç‹¬ç«‹è§£æ
- **å®Œå–„çš„é”™è¯¯å¤„ç†**ï¼šæ¸…æ™°çš„é”™è¯¯è¯Šæ–­ä¿¡æ¯
- **Grafana é›†æˆ**ï¼šåŸç”Ÿæ”¯æŒæ¨¡æ¿å˜é‡

MetricsQL è¯æ³•åˆ†æå™¨ä½“ç°äº†ç°ä»£ç¼–è¯‘å™¨è®¾è®¡çš„æœ€ä½³å®è·µï¼Œæ˜¯ä¸€ä¸ªå€¼å¾—æ·±å…¥å­¦ä¹ çš„é«˜è´¨é‡å¼€æºé¡¹ç›®ã€‚

[â†‘ è¿”å›ç›®å½•](#-ç›®å½•)
